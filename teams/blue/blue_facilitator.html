<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Simulation | BLUE Team Facilitator</title>
    <link rel="stylesheet" href="../../styles/blue_facilitator.css">
    <link rel="stylesheet" href="../../styles/simulation-theme.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
    </style>
</head>

<body>
    <div id="loader" aria-label="Loading simulation environment">
        <div class="loader-globe">
            <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.2" />
                <ellipse cx="24" cy="24" rx="22" ry="10" stroke="currentColor" stroke-width="1.5" fill="none"
                    opacity="0.3" />
                <ellipse cx="24" cy="24" rx="10" ry="22" stroke="currentColor" stroke-width="1.5" fill="none"
                    opacity="0.3" />
                <path d="M2 24h44" stroke="currentColor" stroke-width="1.5" opacity="0.25" />
                <path d="M24 2v44" stroke="currentColor" stroke-width="1.5" opacity="0.25" />
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none" />
            </svg>
            <div class="loader-ring"></div>
        </div>
    </div>
    <!-- Header -->
    <div class="header">
        <div class="header-brand">
            <a href="../../index.html" class="brand-mark" title="Home"><img src="../../img/homebutton_99695.svg"
                    alt="Home" style="width: 100%; height: 100%;"></a>
            <div class="header-title">
                <h1>BLUE Facilitator</h1>
                <p id="moveEpoch">Move 1: Epoch 1 (2027-2030)</p>
                <p id="sessionStatus" style="font-size: 0.75rem; color: #64748b; margin-top: 4px;">Not connected to
                    session</p>
            </div>
        </div>

        <div class="header-controls">
            <div class="control-group" id="sessionControlGroup" style="display: none;">
                <span class="control-label">Session:</span>
                <input type="text" id="sessionIdInput" placeholder="Enter Session ID"
                    style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; width: 200px; font-size: 0.9rem;">
                <button onclick="joinSessionFromFacilitator()"
                    style="padding: 6px 12px; background: #1a4480; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-left: 5px;">
                    Join
                </button>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="section-nav">
                <div class="nav-section-label">Sections</div>

                <div class="nav-item active" data-section="info-requests">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Info Requests</div>
                        <div class="nav-subtitle">Track information needs</div>
                    </div>
                </div>

                <div class="nav-item" data-section="actions">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <polyline points="9 11 12 14 22 4" />
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                        </svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Actions</div>
                        <div class="nav-subtitle">Manage decisions</div>
                    </div>
                    <span class="nav-badge" id="actionsBadge">0</span>
                </div>

                <div class="nav-item" data-section="observations">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Observations</div>
                        <div class="nav-subtitle">Key insights & notes</div>
                    </div>
                    <span class="nav-badge" id="observationsBadge">0</span>
                </div>

                <div class="nav-item" data-section="timeline">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Timeline</div>
                        <div class="nav-subtitle">Session overview</div>
                    </div>
                </div>
                <div class="nav-item" data-section="white-responses">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">WHITE Cell Responses</div>
                        <div class="nav-subtitle">Feedback to BLUE</div>
                    </div>
                    <span class="nav-badge" id="whiteResponsesBadge">0</span>
                </div>
            </div>

            <div class="sidebar-actions"></div>

            <div class="sidebar-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer" id="timer">90:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" id="startTimer">Start</button>
                    <button class="timer-btn" id="pauseTimer">Pause</button>
                    <button class="timer-btn" id="resetTimer">Reset</button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Info Requests Section -->
            <div class="section-content active" id="info-requests">
                <div class="section-header">
                    <h2>Info Requests</h2>
                    <p>Track and manage information requests from the BLUE Team</p>
                </div>

                <div id="phaseGuidanceContainer"></div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="16" x2="12" y2="12" />
                                <line x1="12" y1="8" x2="12.01" y2="8" />
                            </svg>
                        </span>
                        Pending Requests
                    </h3>
                    <div id="pendingRequests">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="16" x2="12" y2="12" />
                                <line x1="12" y1="8" x2="12.01" y2="8" />
                            </svg>
                            <p>No information requests</p>
                            <p>Requests will appear here as they are submitted</p>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                        </span>
                        Submit New Request
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="requestPriority">
                            <option value="">Select Priority</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Category (select all that apply)</label>
                        <div class="quick-buttons">
                            <button class="quick-btn category-checkbox" data-category="economic">Economic Data</button>
                            <button class="quick-btn category-checkbox" data-category="trade">Trade Data</button>
                            <button class="quick-btn category-checkbox" data-category="alliance">Alliance
                                Status</button>
                            <button class="quick-btn category-checkbox" data-category="tech">Tech Assessment</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">What does the team need?</label>
                        <textarea class="form-textarea" id="requestDetails"
                            placeholder="Describe the specific information or clarification needed..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addInfoRequest()">Submit Request</button>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="section-content" id="actions">
                <div class="section-header">
                    <h2>Actions</h2>
                    <p>Manage and track BLUE Team decisions and actions</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <polyline points="9 11 12 14 22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                        </span>
                        Current Actions
                    </h3>
                    <div id="currentActions">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <polyline points="9 11 12 14 22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            <p>No actions recorded</p>
                            <p>Actions will appear here as they are decided</p>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                        </span>
                        Add New Action
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Action Number</label>
                        <input type="text" class="form-input" id="actionNumber" readonly value="Auto-generated">
                    </div>
                    <div class="form-field">
                        <label class="form-label">Mechanism</label>
                        <select class="form-select" id="actionMechanism">
                            <option value="">Select Mechanism</option>
                            <option value="sanctions">Sanctions/Financial Restrictions</option>
                            <option value="export">Export Controls</option>
                            <option value="investment">Investment / Capital Controls</option>
                            <option value="trade">Trade Policy</option>
                            <option value="financial">Financial/ Digital Asset Policy</option>
                            <option value="economic">General Economic Statecraft/Cross-Cutting Tools</option>
                            <option value="industrial">Industrial Policy</option>
                            <option value="infrastructure">Infrastructure & Workforce Development/Supply-Chain
                                Resilience</option>
                            <option value="other">Other (Please specify)</option>
                        </select>
                    </div>
                    <div class="form-field" id="otherMechanismContainer" style="display: none;">
                        <label class="form-label">Please specify the mechanism</label>
                        <input type="text" class="form-input" id="otherMechanismInput"
                            placeholder="Enter custom mechanism...">
                    </div>
                    <div class="form-field">
                        <label class="form-label">Sector</label>
                        <select class="form-select" id="actionSector">
                            <option value="">Select Sector</option>
                            <option value="biotechnology">Biotechnology</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="telecommunications">Telecommunications</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Target (select all that apply)</label>
                        <div class="quick-buttons">
                            <button class="quick-btn target-checkbox" data-target="prc">PRC</button>
                            <button class="quick-btn target-checkbox" data-target="rus">RUS</button>
                            <button class="quick-btn target-checkbox" data-target="ap-aus">AP–AUS</button>
                            <button class="quick-btn target-checkbox" data-target="ap-rok">AP–ROK</button>
                            <button class="quick-btn target-checkbox" data-target="ap-jap">AP–JAP</button>
                            <button class="quick-btn target-checkbox" data-target="eu-eu">EU–EU</button>
                            <button class="quick-btn target-checkbox" data-target="eu-ger">EU–GER</button>
                            <button class="quick-btn target-checkbox" data-target="eu-uk">EU–UK</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Type of Exposure</label>
                        <select class="form-select" id="actionExposure">
                            <option value="">Select Type</option>
                            <option value="critical-minerals">Critical Minerals</option>
                            <option value="supply-chain">Supply Chain</option>
                            <option value="technologies">Technologies</option>
                            <option value="manufacturing">Manufacturing</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Goal</label>
                        <textarea class="form-textarea" id="actionGoal"
                            placeholder="Describe the goal of this action..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Ally Contingencies</label>
                        <textarea class="form-textarea" id="actionContingencies"
                            placeholder="Describe ally contingencies..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Expected Outcomes</label>
                        <textarea class="form-textarea" id="actionOutcomes"
                            placeholder="Describe the expected outcomes..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addAction()">Add Action</button>
                </div>
            </div>

            <!-- Observations Section -->
            <div class="section-content" id="observations">
                <div class="section-header">
                    <h2>Observations</h2>
                    <p>Record key insights, patterns, and important notes from the session</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        </span>
                        Key Observations
                    </h3>
                    <div id="keyObservations">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <p>No observations recorded</p>
                            <p>Key insights will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                        </span>
                        Add Observation
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="observationCategory">
                            <option value="">Select Category</option>
                            <option value="strategic">Strategic Insights</option>
                            <option value="team">Team Dynamics</option>
                            <option value="technical">Technical Issues</option>
                            <option value="decision">Decision Points</option>
                            <option value="risk">Risk Assessment</option>
                            <option value="communication">Communication Patterns</option>
                            <option value="resource">Resource Allocation</option>
                            <option value="timeline">Timeline Issues</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Observation</label>
                        <textarea class="form-textarea" id="newObservationText"
                            placeholder="Record a key insight or important note..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addObservation()">Add Observation</button>
                </div>
            </div>

            <!-- Timeline Section -->
            <div class="section-content" id="timeline">
                <div class="section-header">
                    <h2>Timeline</h2>
                    <p>Overview of the session timeline and key events</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                        </span>
                        Session Timeline
                    </h3>
                    <div id="sessionTimeline">
                        <div class="empty-state">
                            <p>No timeline events</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WHITE Cell Responses Section -->
            <div class="section-content" id="white-responses">
                <div class="section-header">
                    <h2>WHITE Cell Responses</h2>
                    <p>Feedback, adjudication notes, and outcomes provided to BLUE</p>
                </div>
                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                            </svg>
                        </span>
                        Responses (Move <span id="whiteResponsesMove">1</span>)
                    </h3>
                    <div style="margin-bottom:12px;">
                        <button class="btn btn-secondary" id="refreshWhiteResponses">Refresh</button>
                    </div>
                    <div id="whiteResponsesContainer">
                        <div class="empty-state">
                            <p>No responses from WHITE Cell</p>
                            <p>Click refresh to check for updates</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/data-layer.js"></script>
    <script src="../../js/research-tracking.js"></script>
    <script src="../../js/loading.js"></script>
    <script src="../../js/role-dialogs.js"></script>
    <script type="module" src="../../js/facilitator.js"></script>
    <script>
        // Role-specific authentication for Facilitator
        document.addEventListener('DOMContentLoaded', () => {
            const requiredRole = 'blue_facilitator';
            const role = sessionStorage.getItem('esg_role');
            const sessionId = sessionStorage.getItem('esg_session_id');

            // Check both role and session
            if (!role || role !== requiredRole || !sessionId) {
                showRoleLoginPrompt(requiredRole, 'Facilitator');
            } else {
                // Update session status display
                updateSessionStatus();
            }
        });
        // Function to update session status in header
        function updateSessionStatus() {
            const sessionId = sessionStorage.getItem('esg_session_id');
            const statusEl = document.getElementById('sessionStatus');
            if (statusEl && sessionId) {
                // Wait for window.esg.getSessionName to be available
                const checkAndUpdate = () => {
                    if (typeof window.esg !== 'undefined' && window.esg.getSessionName) {
                        window.esg.getSessionName().then(sessionName => {
                            if (sessionName) {
                                statusEl.textContent = sessionName;
                                statusEl.style.color = '#10b981'; // Green color for connected
                            } else {
                                statusEl.textContent = 'Connected to session';
                                statusEl.style.color = '#10b981';
                            }
                        }).catch(() => {
                            statusEl.textContent = 'Connected to session';
                            statusEl.style.color = '#10b981';
                        });
                    } else {
                        // Retry after a short delay
                        setTimeout(checkAndUpdate, 100);
                    }
                };
                checkAndUpdate();
            } else if (statusEl) {
                statusEl.textContent = 'Not connected to session';
                statusEl.style.color = '#64748b';
            }
        }

        function showRoleLoginPrompt(role, roleName) {
            // Hide the page content
            const mainContent = document.body;
            if (mainContent) {
                mainContent.style.overflow = 'hidden';
            }

            // Hide all page content except the modal
            const allChildren = Array.from(document.body.children);
            allChildren.forEach(child => {
                if (child.id !== 'roleLoginOverlay') {
                    child.style.display = 'none';
                }
            });

            const overlay = document.createElement('div');
            overlay.id = 'roleLoginOverlay';
            overlay.className = 'modal-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; animation: fadeIn 0.2s ease;';

            overlay.innerHTML = `
                <div class="modal-content" style="background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 12px; box-shadow: 0 2px 8px rgba(26, 68, 128, 0.04), 0 8px 32px rgba(26, 68, 128, 0.06); max-width: 450px; width: 90%; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; position: relative;" onclick="event.stopPropagation()">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #1a4480; border-radius: 12px 12px 0 0;"></div>
                    <div style="padding: 24px 24px 16px; border-bottom: 1px solid #EDF2F7;">
                        <h2 style="font-size: 1.15rem; font-weight: 400; color: #1C2331; margin: 0; letter-spacing: -0.01em;">${roleName} Login Required</h2>
                    </div>
                    <div style="padding: 20px 24px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a1a1a; font-size: 0.875rem;">Session ID or Name:</label>
                            <input type="text" id="roleLoginSession" placeholder="Enter session ID or name" 
                                   style="width: 100%; padding: 12px 14px; border: 1px solid #EDF2F7; border-radius: 8px; box-sizing: border-box; font-size: 0.9375rem; font-family: 'Inter', sans-serif; background: #FAFAFA; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);"
                                   autocomplete="off"
                                   onfocus="this.style.borderColor='#1a4480'; this.style.boxShadow='0 0 0 3px rgba(26, 68, 128, 0.1)'; this.style.background='#FFFFFF'"
                                   onblur="this.style.borderColor='#EDF2F7'; this.style.boxShadow='none'; this.style.background='#FAFAFA'">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a1a1a; font-size: 0.875rem;">Password:</label>
                            <input type="password" id="roleLoginPassword" 
                                   style="width: 100%; padding: 12px 14px; border: 1px solid #EDF2F7; border-radius: 8px; box-sizing: border-box; font-size: 0.9375rem; font-family: 'Inter', sans-serif; background: #FAFAFA; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);"
                                   onkeypress="if(event.key === 'Enter') attemptRoleLogin('${role}')"
                                   onfocus="this.style.borderColor='#1a4480'; this.style.boxShadow='0 0 0 3px rgba(26, 68, 128, 0.1)'; this.style.background='#FFFFFF'"
                                   onblur="this.style.borderColor='#EDF2F7'; this.style.boxShadow='none'; this.style.background='#FAFAFA'">
                        </div>
                    </div>
                    <div style="padding: 16px 24px 24px; border-top: 1px solid #EDF2F7; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeRoleLoginPrompt()" 
                                class="modal-btn-secondary"
                                style="padding: 12px 14px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #EDF2F7; background: #FAFAFA; color: #1C2331; display: inline-flex; align-items: center; gap: 8px;">
                            Cancel
                        </button>
                        <button onclick="attemptRoleLogin('${role}')" 
                                class="modal-btn-primary"
                                style="padding: 12px 14px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #1a4480; background: #1a4480; color: white; display: inline-flex; align-items: center; gap: 8px;">
                            Login
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            setTimeout(() => {
                const sessionInput = document.getElementById('roleLoginSession');
                if (sessionInput) sessionInput.focus();
            }, 100);
        }

        function closeRoleLoginPrompt() {
            const overlay = document.getElementById('roleLoginOverlay');
            if (overlay) overlay.remove();

            // Restore page content visibility
            const mainContent = document.body;
            if (mainContent) {
                mainContent.style.overflow = '';
            }

            const allChildren = Array.from(document.body.children);
            allChildren.forEach(child => {
                child.style.display = '';
            });

            window.location.href = '../../index.html';
        }

        async function attemptRoleLogin(role) {
            if (typeof window.esg === 'undefined') {
                if (window.showAlertModal) {
                    await window.showAlertModal('Authentication system not loaded. Please refresh the page.', 'System Error');
                } else {
                    alert('Authentication system not loaded. Please refresh the page.');
                }
                return;
            }

            const sessionInput = document.getElementById('roleLoginSession');
            const passwordInput = document.getElementById('roleLoginPassword');
            const sessionIdOrName = sessionInput ? sessionInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!sessionIdOrName) {
                if (window.showAlertModal) {
                    await window.showAlertModal('Please enter a session ID or name', 'Session Required');
                } else {
                    alert('Please enter a session ID or name');
                }
                if (sessionInput) sessionInput.focus();
                return;
            }

            if (!password) {
                if (window.showAlertModal) {
                    await window.showAlertModal('Please enter a password', 'Password Required');
                } else {
                    alert('Please enter a password');
                }
                if (passwordInput) passwordInput.focus();
                return;
            }

            // First validate the role password
            const passwordValid = window.esg.login(role, password);
            if (!passwordValid) {
                if (window.showAlertModal) {
                    await window.showAlertModal('Invalid password. Please try again.', 'Authentication Failed');
                } else {
                    alert('Invalid password. Please try again.');
                }
                if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                return;
            }

            // Then find and join the session
            try {
                let sessionId = sessionIdOrName;

                // Check if it's a session ID (UUID format) or a name
                const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(sessionIdOrName);

                if (!isUUID) {
                    // It's a name, search for the session
                    const sessions = await window.esg.fetchAllSessions(true); // Include all sessions
                    const matchingSession = sessions.find(s =>
                        s.name && s.name.toLowerCase() === sessionIdOrName.toLowerCase()
                    );

                    if (!matchingSession) {
                        if (window.showAlertModal) {
                            await window.showAlertModal('Session not found. Please check the session name or ID.', 'Session Not Found');
                        } else {
                            alert('Session not found. Please check the session name or ID.');
                        }
                        if (sessionInput) {
                            sessionInput.value = '';
                            sessionInput.focus();
                        }
                        return;
                    }

                    sessionId = matchingSession.id;
                }

                // ========== NEW: Check role availability ==========
                const availability = await window.esg.checkRoleAvailability(sessionId, role);

                if (!availability.available) {
                    if (availability.reason === 'role_full') {
                        const roleName = window.esg.ROLE_DISPLAY_NAMES?.[role] || role;
                        const action = await window.showRoleTakeoverDialog(roleName, availability);

                        if (action === 'takeover') {
                            // Disconnect existing participants
                            await window.esg.disconnectExistingParticipants(sessionId, role);
                        } else {
                            return; // User cancelled
                        }
                    }
                }
                // ===================================================

                // Join the session
                const joinSuccess = await window.esg.joinSession(sessionId);
                if (!joinSuccess) {
                    if (window.showAlertModal) {
                        await window.showAlertModal('Session not found or is no longer active. Please check the session ID or name.', 'Session Not Found');
                    } else {
                        alert('Session not found or is no longer active. Please check the session ID or name.');
                    }
                    if (sessionInput) {
                        sessionInput.value = '';
                        sessionInput.focus();
                    }
                    return;
                }

                // ========== NEW: Register as session participant ==========
                const clientId = sessionStorage.getItem('esg_client_id');
                const registration = await window.esg.registerSessionParticipant(sessionId, clientId, role);

                if (!registration) {
                    console.warn('Failed to register session participant, but allowing login');
                }

                // ========== NEW: Start heartbeat ==========
                if (window.researchTracking?.startParticipantHeartbeat) {
                    window.researchTracking.startParticipantHeartbeat();
                }
                // ===========================================

                // Success! Remove overlay and restore page
                const overlay = document.getElementById('roleLoginOverlay');
                if (overlay) overlay.remove();

                // Restore page content visibility
                const mainContent = document.body;
                if (mainContent) {
                    mainContent.style.overflow = '';
                }

                const allChildren = Array.from(document.body.children);
                allChildren.forEach(child => {
                    child.style.display = '';
                });

                if (window.esg.showToast) {
                    window.esg.showToast('Logged in and joined session successfully');
                }
                // Reload to apply authentication and session
                window.location.reload();
            } catch (error) {
                console.error('Login error:', error);
                if (window.showAlertModal) {
                    await window.showAlertModal('Error joining session: ' + (error.message || 'Please try again.'), 'Error');
                } else {
                    alert('Error joining session: ' + (error.message || 'Please try again.'));
                }
            }
        }

        window.closeRoleLoginPrompt = closeRoleLoginPrompt;
        window.attemptRoleLogin = attemptRoleLogin;

        // Navigation and initialization logic is now handled in facilitator.js
    </script>
</body>

</html>